# OpenLiteSpeed Configuration for PHP-SVG Processing
# High-performance web server with 2-3x faster PHP execution

# Server root and basic settings
serverName                php-svg-server
user                      nobody
group                     nogroup
priority                  0
autoRestart               1
chrootPath                $SERVER_ROOT
enableChroot              0
inMemBufSize              60M
swappingDir               /tmp/lshttpd/swap
autoFix503                1

# Error and access logs
errorlog $SERVER_ROOT/logs/error.log {
  logLevel                DEBUG
  debugLevel              0
  rollingSize             10M
  enableStderrLog         1
}

accesslog $SERVER_ROOT/logs/access.log {
  rollingSize             10M
  keepDays                30
  compressArchive         0
}

# Index files
index  {
  useServer               0
  indexFiles              index.html, index.php, index.svg
  autoIndex               0
  autoIndexURI            /_autoindex/default.php
}

# MIME type configuration
mime $SERVER_ROOT/conf/mime.properties

# Show version info
showVersionNumber         0
hideSigInErrorPage        0

# General settings
useIpInProxyHeader        1
autoLoadHtaccess          1

# Module configuration
module cache {
  internal                1
  
  ls_enabled              1
}

# PHP Script Handler
scripthandler  {
  add                     lsphp82 php
  add                     lsphp82 svg
}

# Rails Runner (if needed)
railsDefaults  {
  maxConns                1
  procSoftLimit           1200
  procHardLimit           1300
  runOnStartUp            1
}

# Virtual Host for PHP-SVG processing
virtualhost php-svg {
  vhRoot                  /home/tom/github/veridock/grid/php
  configFile              $SERVER_ROOT/conf/vhosts/php-svg/vhconf.conf
  allowSymbolLink         1
  enableScript            1
  restrained              0
  setUIDMode              0
}

# Listener configuration
listener Default {
  address                 *:8097
  secure                  0
  map                     php-svg *
}

# SSL Listener (for production)
listener SSL {
  address                 *:8443
  secure                  1
  keyFile                 $SERVER_ROOT/conf/cert/server.key
  certFile                $SERVER_ROOT/conf/cert/server.crt
  certChain               1
  ciphers                 EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
  enableECDHE             1
  renegProtection         1
  sslSessionCache         1
  sslSessionTickets       1
  enableSpdy              15
  enableQuic              1
  map                     php-svg *
}

# Tuning settings
tuning  {
  maxConnections          10000
  maxSSLConnections       1000
  connTimeout             300
  maxKeepAliveReq         10000
  keepAliveTimeout        5
  sndBufSize              0
  rcvBufSize              0
  maxReqURLLen            32768
  maxReqHeaderSize        65536
  maxReqBodySize          2047M
  maxDynRespHeaderSize    32768
  maxDynRespSize          2047M
  maxCachedFileSize       4096
  totalInMemCacheSize     20M
  maxMMapFileSize         256K
  totalMMapCacheSize      40M
  useSendfile             1
  fileETag                28
  enableGzipCompress      1
  compressibleTypes       text/*, application/x-javascript, application/xml, application/javascript, image/svg+xml
  enableDynGzipCompress   1
  gzipCompressLevel       6
  gzipAutoUpdateStatic    1
  gzipMinFileSize         300
  gzipMaxFileSize         10M
  gzipStaticCompressLevel 6
  brStaticCompressLevel   6
  enableBrCompress        1
  SSITimeFormat           %a %b %e %H:%M:%S %Z %Y
}

# Security settings
security  {
  fileAccessControl  {
    followSymbolLink      1
    checkSymbolLink       0
    requiredPermissionMask 000
    restrictedPermissionMask 000
  }
  
  perClientConnLimit  {
    staticReqPerSec       0
    dynReqPerSec          0
    outBandwidth          0
    inBandwidth           0
    softLimit             10000
    hardLimit             10000
    gracePeriod           15
    banPeriod             300
  }
  
  CGIRLimit  {
    maxCGIInstances       20
    minUID                11
    minGID                10
    forceGID              0
  }
  
  accessDenyDir  {
    dir                   /
    dir                   /etc/*
    dir                   /dev/*
    dir                   conf/*
    dir                   admin/conf/*
  }
  
  accessControl  {
    allow                 ALL, 127.0.0.1
    deny                  
  }
}

# External applications (PHP-FPM)
extprocessor lsphp82 {
  type                    lsphp
  address                 uds://tmp/lshttpd/lsphp.sock
  maxConns                35
  initTimeout             60
  retryTimeout            0
  pcKeepAliveTimeout      1
  respBuffer              0
  autoStart               1
  path                    /usr/local/lsws/lsphp82/bin/lsphp
  backlog                 100
  instances               1
  priority                0
  memSoftLimit            2047M
  memHardLimit            2047M
  procSoftLimit           1400
  procHardLimit           1500
  
  env                     PHP_LSAPI_CHILDREN=35
  env                     PHP_LSAPI_MAX_REQUESTS=10000
  env                     PHP_LSAPI_EXTRA_HEADERS=1
  env                     PATH=$PATH
  
  enableCoreDump          0
}

# Cache settings
cache  {
  enableCache             0
  qsCache                 1
  reqCookieCache          1
  respCookieCache         1
  ignoreReqCacheCtrl      1
  ignoreRespCacheCtrl     0
  
  enablePrivateCache      0
  privateExpireInSeconds  3600
  
  storagePath             /tmp/lshttpd/cache
  expireInSeconds         86400
  enableStale             0
  staleAge                200
  maxCacheObjSize         10000000
  maxStaleAge             200
  
  ls_enabled              1
}
