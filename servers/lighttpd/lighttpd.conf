# Lighttpd configuration for PHP-SVG processing
# Ultra-lightweight server (<5MB RAM) for resource-constrained environments

# Basic server configuration
server.modules = (
    "mod_access",
    "mod_alias",
    "mod_compress",
    "mod_redirect",
    "mod_rewrite",
    "mod_fastcgi",
    "mod_accesslog"
)

# Server settings
server.document-root = "/home/tom/github/veridock/grid/php"
server.upload-dirs = ( "/var/cache/lighttpd/uploads" )
server.errorlog = "/var/log/lighttpd/error.log"
server.pid-file = "/var/run/lighttpd.pid"
server.username = "www-data"
server.groupname = "www-data"
server.port = 8097
server.bind = "0.0.0.0"

# Enable compression
compress.cache-dir = "/var/cache/lighttpd/compress/"
compress.filetype = ( "application/javascript", "text/css", "text/html", "text/plain", "image/svg+xml" )

# Index files
index-file.names = ( "index.php", "index.html", "index.htm", "default.htm" )

# URL handling
url.access-deny = ( "~", ".inc" )

# Static file optimization
static-file.exclude-extensions = ( ".php", ".pl", ".fcgi" )

# Access logging
accesslog.filename = "/var/log/lighttpd/access.log"

# MIME types
mimetype.assign = (
    ".pdf" => "application/pdf",
    ".sig" => "application/pgp-signature",
    ".spl" => "application/futuresplash",
    ".class" => "application/octet-stream",
    ".ps" => "application/postscript",
    ".torrent" => "application/x-bittorrent",
    ".dvi" => "application/x-dvi",
    ".gz" => "application/x-gzip",
    ".pac" => "application/x-ns-proxy-autoconfig",
    ".swf" => "application/x-shockwave-flash",
    ".tar.gz" => "application/x-tgz",
    ".tgz" => "application/x-tgz",
    ".tar" => "application/x-tar",
    ".zip" => "application/zip",
    ".mp3" => "audio/mpeg",
    ".m3u" => "audio/x-mpegurl",
    ".wma" => "audio/x-ms-wma",
    ".wax" => "audio/x-ms-wax",
    ".ogg" => "application/ogg",
    ".wav" => "audio/x-wav",
    ".gif" => "image/gif",
    ".jar" => "application/x-java-archive",
    ".jpg" => "image/jpeg",
    ".jpeg" => "image/jpeg",
    ".png" => "image/png",
    ".xbm" => "image/x-xbitmap",
    ".xpm" => "image/x-xpixmap",
    ".xwd" => "image/x-xwindowdump",
    ".css" => "text/css",
    ".html" => "text/html",
    ".htm" => "text/html",
    ".js" => "application/javascript",
    ".asc" => "text/plain",
    ".c" => "text/plain",
    ".cpp" => "text/plain",
    ".log" => "text/plain",
    ".conf" => "text/plain",
    ".text" => "text/plain",
    ".txt" => "text/plain",
    ".dtd" => "text/xml",
    ".xml" => "text/xml",
    ".mpeg" => "video/mpeg",
    ".mpg" => "video/mpeg",
    ".mov" => "video/quicktime",
    ".qt" => "video/quicktime",
    ".avi" => "video/x-msvideo",
    ".asf" => "video/x-ms-asf",
    ".asx" => "video/x-ms-asf",
    ".wmv" => "video/x-ms-wmv",
    ".bz2" => "application/x-bzip",
    ".tbz" => "application/x-bzip-compressed-tar",
    ".tar.bz2" => "application/x-bzip-compressed-tar",
    # Special handling for SVG files - process as PHP
    ".svg" => "application/x-httpd-php"
)

# FastCGI configuration for PHP
fastcgi.server = (
    ".php" => ((
        "bin-path" => "/usr/bin/php-cgi",
        "socket" => "/var/run/lighttpd/php.socket",
        "max-procs" => 4,
        "idle-timeout" => 20,
        "bin-environment" => (
            "PHP_FCGI_CHILDREN" => "2",
            "PHP_FCGI_MAX_REQUESTS" => "1000"
        ),
        "bin-copy-environment" => (
            "PATH", "SHELL", "USER"
        )
    )),
    # Process SVG files through PHP
    ".svg" => ((
        "bin-path" => "/usr/bin/php-cgi",
        "socket" => "/var/run/lighttpd/php-svg.socket",
        "max-procs" => 2,
        "idle-timeout" => 20,
        "bin-environment" => (
            "PHP_FCGI_CHILDREN" => "1",
            "PHP_FCGI_MAX_REQUESTS" => "500"
        ),
        "bin-copy-environment" => (
            "PATH", "SHELL", "USER"
        )
    ))
)

# Custom headers for SVG files
$HTTP["url"] =~ "\.svg$" {
    setenv.add-response-header = (
        "Content-Type" => "image/svg+xml; charset=utf-8",
        "Cache-Control" => "no-cache, must-revalidate",
        "X-Powered-By" => "Lighttpd + PHP-SVG",
        "Access-Control-Allow-Origin" => "*"
    )
}

# Security settings
server.follow-symlink = "enable"

# Performance tuning for low-resource environments
server.max-connections = 256
server.max-fds = 512
server.stat-cache-engine = "simple"
server.max-worker = 2

# Directory listing (disable for security)
dir-listing.activate = "disable"

# Conditional configuration for different file types
$HTTP["url"] =~ "\.(css|js|png|jpg|jpeg|gif|ico|woff|woff2)$" {
    expire.url = ( "" => "access plus 1 months" )
}

# Error pages
server.error-handler-404 = "/error.html"

# Include additional configuration files
#include_shell "/usr/share/lighttpd/create-mime.assign.pl"
include_shell "/usr/share/lighttpd/include-conf-enabled.pl"
